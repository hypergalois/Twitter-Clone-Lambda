<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <!-- <link rel="stylesheet" href="../style/index.css"> -->
  <link href="https://fonts.googleapis.com/css?family=Nunito+Sans:300i,400,700&display=swap" rel="stylesheet">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

  <script>
    // Aquí iría la función de obtener avatar y user a partir de id
    var user = 'roberto'
    var user_id = 3
    var avatar = ''



    function getAWSKeys() {
      var asd = $.get(
        "https://7un4s6tfapjwovlixtvcc2ujrq0qazup.lambda-url.us-east-1.on.aws/", {},
        function(data) {

          var json = data;

          document.getElementById("Policy").value = json.stringToSign;
          document.getElementById("X-Amz-Credential").value = json.xAmzCredential;
          document.getElementById("X-Amz-Date").value = json.amzDate;
          document.getElementById("X-Amz-Signature").value = json.stringSigned;
          document.getElementById("X-Amz-Security-Token").value = json.securityToken;

        }
      )

    }

    function ofuscarUrl(url) {
      var fecha = Date.now();
      return fecha + url;
    }

    function getType(name) {
      var re = /(?:\.([^.]+))?$/;
      var nameEx = re.exec(name)[1];
      var type = "";
      extensionsVideo = ["m4v", "avi", "mpg", "mp4", "webm"];
      extensionsImage = ["jpg", "gif", "bmp", "png"];

      for (var i = 0; i < extensionsVideo.length; i++) {
        if (nameEx == extensionsVideo[i]) {
          type = "video";
        }
      }
      for (var i = 0; i < extensionsImage.length; i++) {
        if (nameEx == extensionsImage[i]) {
          type = "image";
        }
      }
      if (type == "") {
        alert("Tipo de archivo no soportado.");
        return "None";
      }
      return type;
    }

    // function setKeyFilename() {
    //   document.getElementById("key").value = document.getElementById("file").value.substring(document.getElementById("file").value.lastIndexOf('\\') + 1);
    // }

    function sendTweet(event) {
      // event.preventDefault()
      // Comprobamos que tenemos texto o imagen, lo minimo para que se pueda subir algo
      var varText = document.getElementById('tweet').value
      var fileInput = document.getElementById('file')

      if (varText.trim() == '' && fileInput.files.length == 0) {
        alert('Por favor, ingresa un mensaje o selecciona un archivo.')
        return false
      }

      alert("Mandamos")
      alert(varText)
      // alert(fileInput.files)

      var res = ''
      // var error = ''

      // Hay que diferenciar dos casos, donde tenemos un adjunto y cuando no lo tenemos

      // Si solo tenemos texto
      if (fileInput.files.length == 0) {

        var asd = $.get(
          'https://5yato236iqwpzmtpzydt3ayyoy0kfjoq.lambda-url.us-east-1.on.aws/', {
            method: 'tweet-text',
            user_id: user_id,
            message: varText
          },
          function(data) {
            function jsonEscape(str) {
              return str.replace(/\n/g, "\\\\n").replace(/\r/g, "\\\\r").replace(/\t/g, "\\\\t").replace(/\\/g, "");
            }

            var json = data
            result = json.res
          }
        ).done(function() {
          if (result == 'ok') {
            alert('Tweet publicado con éxito.')
            // Aqui redirigimos a perfil o home
            window.location.replace('home.html')
          } else if (result == 'fail') {
            alert('Error al publicar el tweet. Inténtalo de nuevo.')
          }
        })

      } else {
        // Tweet con al menos un archivo y texto o no texto
        var file = document.getElementById("file").value.substring(document.getElementById("file").value.lastIndexOf('\\') + 1)
        var tipo = getType(file)
        var fileName = ofuscarUrl(file)

        document.getElementById('key').value = fileName

        alert(fileName)
        alert(tipo)

        // Como tenemos dos tablas lo podríamos hacer por separado en dos funciones
        // Mandamos id_user, tweet, fileName y tipo
        // fileName va a adjuntos y conseguimos el id que nos asignen
        // y crearemos un mensaje con user_id, message y el attachment_id

        var asd = $.get(
          'https://g2ojaeva3vapo3uptqk3kxow440gmrmu.lambda-url.us-east-1.on.aws/', 
          {
            method: 'tweet-text-attachment',
            user_id: user_id,
            message: varText,
            file_name: fileName,
            file_type: tipo
          },
          function(data) {
            function jsonEscape(str) {
              return str.replace(/\n/g, "\\\\n").replace(/\r/g, "\\\\r").replace(/\t/g, "\\\\t").replace(/\\/g, "");
            }

            var json = data
            result = json.res
          }
        ).done(function() {
          if (result == 'ok') {
            alert('Tweet publicado con éxito.')
            // Aqui redirigimos a perfil o home
            window.location.replace('home.html')
          } else if (result == 'fail') {
            alert('Error al publicar el tweet. Inténtalo de nuevo.')
          }
        })

        // return true
      }

    }
  </script>

</head>

<body onload="getAWSKeys()">

  <textarea id="tweet" class="search-input" name="" id="" cols="60" rows="8"></textarea>

  <form action="http://twitter-clone-utad.s3.us-east-1.amazonaws.com/" method="post" enctype="multipart/form-data" onsubmit="sendTweet(event)">
    <input type="hidden" id="X-Amz-Credential" name="X-Amz-Credential" value="" />
    <input type="hidden" id="X-Amz-Date" name="X-Amz-Date" value="" />
    <input type="hidden" id="Policy" name="Policy" value="" />
    <input type="hidden" id="X-Amz-Signature" name="X-Amz-Signature" value="" />
    <input type="hidden" id="key" name="key" value="fichero.sln" /><br />
    <input type="hidden" name="acl" value="public-read" />
    <input type="hidden" name="X-Amz-Algorithm" value="AWS4-HMAC-SHA256" />
    <input type="hidden" id="X-Amz-Security-Token" name="X-Amz-Security-Token" value="" />
    Select file to upload:
    <input type="file" name="file" id="file" accept="video/mp4,image/png">
    <input type="submit" value="Upload Image" name="submit">
  </form>

</body>

</html>